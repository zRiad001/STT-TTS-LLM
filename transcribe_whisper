import sys
from faster_whisper import WhisperModel
from pathlib import Path

# ===== Settings =====
# GPU √º√ß√ºn daha d…ôqiq model:
MODEL_SIZE = "small.en"        # "small.en" ingilis komanda √º√ß√ºn √ßox yax≈üƒ±dƒ±r
COMPUTE    = "int8_float16"    # GPU √º√ß√ºn ideal balans
DEVICE     = "cuda"            # GPU

# Komanda konteksti (Whisper-…ô hint veririk)
COMMAND_PROMPT = (
    "This audio contains short voice commands for a local assistant. "
    "Possible commands include: open camera, close camera, show camera, hide camera, "
    "turn on camera, turn off camera, what do you see in front of the camera, "
    "what is in the picture, analyze frame, and similar phrases. "
    "Transcribe these commands clearly and literally."
)

def transcribe_file(audio_path: str):
    audio = Path(audio_path)
    if not audio.exists():
        print(f"‚ùå Tapƒ±lmadƒ±: {audio}")
        sys.exit(1)

    print(f"üîä Fayl: {audio}")
    print(f"üß† Model: {MODEL_SIZE}, device={DEVICE}, compute_type={COMPUTE}")

    # ∆èvv…ôl GPU, alƒ±nmasa CPU fallback
    try:
        model = WhisperModel(MODEL_SIZE, device="cuda", compute_type=COMPUTE)
        using_device = "cuda"
    except Exception as e:
        print(f"‚ö†Ô∏è CUDA alƒ±nmadƒ± ({e}), CPU-ya ke√ßir…ôm...")
        model = WhisperModel(MODEL_SIZE, device="cpu", compute_type="int8")
        using_device = "cpu"

    print(f"üß† Real device: {using_device}")

    segments, info = model.transcribe(
        str(audio),
        vad_filter=True,       # daxili VAD filtri
        beam_size=5,           # daha d…ôqiq
        best_of=5,
        language="en",         # komanda dili …ôsas…ôn ingilisdirs…ô
        initial_prompt=COMMAND_PROMPT,
    )
    print(f"üåê Dil: {info.language} | no_speech_prob={getattr(info, 'no_speech_prob', None)}")

    text = "".join(s.text for s in segments).strip()
    print("\n=== N…ôtic…ô ===")
    print(text)
    return text

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("ƒ∞stifad…ô: python transcribe_whisper.py <audio.wav/mp3/m4a>")
        sys.exit(1)
    transcribe_file(sys.argv[1])
