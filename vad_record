import sounddevice as sd
import numpy as np
import webrtcvad
import collections
import wave
import time
import signal

RATE = 16000
FRAME_DURATION = 30  # ms (allowed: 10 / 20 / 30)
FRAME_SIZE = int(RATE * FRAME_DURATION / 1000)

# VAD AGGRESSIVENESS:
# 0 = most strict (harder to trigger, needs clear voice)
# 3 = most sensitive (triggers on tiny noise)
VAD = webrtcvad.Vad(0)   # was 1 before -> now less sensitive

MAX_DURATION_S = 120     # safety cap

# how "sticky" recording is:
START_TRIGGER_FRAMES = 10   # how many voiced frames in a row before we "start"
STOP_TRIGGER_FRAMES  = 45   # how many silence frames in a row before we "stop"


def record_vad(output="output.wav", silence_limit=1.6, device=None):
    """
    Voice-activated recorder:
    - waits until it hears real voice (not tiny noise)
    - records
    - stops after sustained silence
    """

    if device is not None:
        sd.default.device = device

    # buffer of recent silence while we're already recording
    ring_buffer = collections.deque(
        maxlen=int(silence_limit * 1000 / FRAME_DURATION)
    )

    frames = []
    recording = False
    voiced_streak = 0
    silence_streak = 0
    started_at = time.time()

    print("ğŸ™ï¸ DanÄ±ÅŸ â€” sÃ¼kut zamanÄ± dayandÄ±rÄ±lacaq...  (Ctrl+C = mÉ™cburi stop)")

    def handle_sigint(sig, frame):
        print("\nâ¹ï¸ Ctrl+C ilÉ™ dayandÄ±rÄ±ldÄ±.")
        raise KeyboardInterrupt

    signal.signal(signal.SIGINT, handle_sigint)

    try:
        with sd.RawInputStream(
            samplerate=RATE,
            blocksize=FRAME_SIZE,
            dtype='int16',
            channels=1,
            device=device
        ) as stream:
            while True:
                # safety hard stop
                if time.time() - started_at > MAX_DURATION_S and recording:
                    print("â¹ï¸ Maksimum mÃ¼ddÉ™tÉ™ Ã§atdÄ±, yazma dayandÄ±rÄ±ldÄ±.")
                    break

                raw_frame, overflowed = stream.read(FRAME_SIZE)
                if overflowed:
                    print("âš ï¸ Audio buffer overflow (mikrofon gecikmÉ™si)")

                frame = np.frombuffer(raw_frame, dtype=np.int16)

                # VAD decision
                is_speech = VAD.is_speech(frame.tobytes(), RATE)

                if not recording:
                    # we haven't started yet
                    if is_speech:
                        voiced_streak += 1
                        if voiced_streak >= START_TRIGGER_FRAMES:
                            print("â–¶ï¸ SÉ™s aÅŸkarlandÄ±, yazma baÅŸladÄ±...")
                            recording = True
                            frames.append(frame.copy())
                            ring_buffer.clear()
                            silence_streak = 0
                    else:
                        voiced_streak = 0  # reset if no consistent speech
                else:
                    # we are already recording
                    if is_speech:
                        frames.append(frame.copy())
                        ring_buffer.clear()
                        silence_streak = 0
                    else:
                        ring_buffer.append(frame.copy())
                        silence_streak += 1
                        if silence_streak >= STOP_TRIGGER_FRAMES:
                            print("â¹ï¸ SÃ¼kut zamanÄ± keÃ§di, yazma dayandÄ±rÄ±ldÄ±.")
                            break

    except KeyboardInterrupt:
        pass

    finally:
        if frames:
            try:
                with wave.open(output, 'wb') as wf:
                    wf.setnchannels(1)
                    wf.setsampwidth(2)
                    wf.setframerate(RATE)
                    wf.writeframes(np.concatenate(frames).tobytes())

                duration = len(frames) * FRAME_SIZE / RATE
                print(f"ğŸ’¾ Yadda saxlanÄ±ldÄ±: {output}")
                print(f"â±ï¸ MÃ¼ddÉ™t: {duration:.2f} saniyÉ™")
                print(f"ğŸ“Š Frame sayÄ±: {len(frames)}")
                return output

            except Exception as e:
                print(f"âŒ Fayl yazma xÉ™tasÄ±: {e}")
                return None
        else:
            print("âš ï¸ HeÃ§ nÉ™ yazÄ±lmadÄ± (sÉ™s aÅŸkarlanmadÄ±).")
            print("ğŸ’¡ MÉ™slÉ™hÉ™t: danÄ±ÅŸanda bir az yÃ¼ksÉ™k sÉ™slÉ™ baÅŸla ki, START_TRIGGER_FRAMES dolsun.")
            return None


if __name__ == "__main__":
    record_vad(output="output.wav", silence_limit=1.0)
